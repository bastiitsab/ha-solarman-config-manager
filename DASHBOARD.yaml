# Complete Solarman Backup Dashboard
# Copy this YAML and paste it into your Lovelace dashboard

type: vertical-stack
cards:
  - type: markdown
    content: |
      ## üîß Solarman Configuration Manager
      
      Export backups and compare configurations in one place.
      
  # Backup Section
  - type: entities
    title: Backup Operations
    entities:
      - type: button
        name: Export Configuration Now
        icon: mdi:download
        action_name: Export
        tap_action:
          action: call-service
          service: solarman_config_manager.export_config
      - entity: sensor.solarman_config_manager_files
        name: Total Backup Files
        icon: mdi:file-multiple
        
  # File Selection Section
  - type: entities
    title: Compare Configurations
    entities:
      - entity: input_select.solarman_file1
        name: Select File 1 (Older)
      - entity: input_select.solarman_file2
        name: Select File 2 (Newer)
      - entity: input_boolean.solarman_config_only
        name: Configuration Only (Hide Sensors)
      - entity: input_button.solarman_compare
        name: Compare Selected Files
            
  # Comparison Result Summary
  - type: markdown
    content: |
      ### üìä Latest Comparison Result
      
      **Status:** {{ states('sensor.solarman_config_manager_comparison_result') }}
      
      {% set data = state_attr('sensor.solarman_config_manager_comparison_result', 'summary') %}
      {% if data and data.changed is defined %}
      {% set comp_file = state_attr('sensor.solarman_config_manager_comparison_result', 'comparison_file') %}
      {% if comp_file %}
      **Comparison File:** `{{ comp_file }}`
      {% endif %}
      
      **Summary:**
      - ‚úèÔ∏è Changed: {{ data.changed }}
      - ‚ûï Added: {{ data.added }}
      - ‚ûñ Removed: {{ data.removed }}
      - ‚úÖ Unchanged: {{ data.unchanged }}
      
      {% set file1 = state_attr('sensor.solarman_config_manager_comparison_result', 'file1') %}
      {% set file2 = state_attr('sensor.solarman_config_manager_comparison_result', 'file2') %}
      {% if file1 and file2 %}
      **Comparing:**
      - üìÑ File 1: `{{ file1 }}`
      - üìÑ File 2: `{{ file2 }}`
      {% endif %}
      
      {% if state_attr('sensor.solarman_config_manager_comparison_result', 'config_only') %}
      ‚ÑπÔ∏è _Showing configuration changes only._
      {% endif %}
      {% else %}
      _No comparison performed yet or data format mismatch. Select two files above and click Compare._
      {% endif %}
      
  # Detailed Changes
  - type: conditional
    conditions:
      - entity: sensor.solarman_config_manager_comparison_result
        state_not: "No comparison yet"
    card:
      type: markdown
      content: |
        ### üîç Detailed Changes
        
        {% set changes = state_attr('sensor.solarman_config_manager_comparison_result', 'changes') %}
        {% if changes %}
        {% for entity_id, change in changes.items() %}
        **{{ entity_id.replace('number.', '').replace('_', ' ').title() }}**
        - üî¥ Old: `{{ change.old_value }}`
        - üü¢ New: `{{ change.new_value }}`
        {% if change.changed_attributes %}
        - üìù Attributes: {{ change.changed_attributes | join(', ') }}
        {% endif %}
        
        {% endfor %}
        {% else %}
        ‚úÖ No configuration changes detected.
        {% endif %}
        
        {% set added = state_attr('sensor.solarman_config_manager_comparison_result', 'added_entities') %}
        {% if added and added | length > 0 %}
        
        **‚ûï Added Entities:**
        {% for entity in added %}
        - {{ entity }}
        {% endfor %}
        {% endif %}
        
        {% set removed = state_attr('sensor.solarman_config_manager_comparison_result', 'removed_entities') %}
        {% if removed and removed | length > 0 %}
        
        **‚ûñ Removed Entities:**
        {% for entity in removed %}
        - {{ entity }}
        {% endfor %}
        {% endif %}
        
  # Restore Section
  - type: entities
    title: üîÑ Restore Configuration
    entities:
      - entity: input_select.solarman_restore_file
        name: Select Comparison File
      - entity: input_select.solarman_restore_direction
        name: Restore Direction
      - entity: input_boolean.solarman_restore_dry_run
        name: Dry Run (Preview Only)
      - type: button
        name: Restore Configuration
        icon: mdi:restore
        action_name: Restore
        tap_action:
          action: call-service
          service: script.solarman_restore_config
        
  # Restore Result
  - type: markdown
    content: |
      ### üîÑ Restore Status
      
      **Last Restore:** {{ states('sensor.solarman_config_manager_restore_result') }}
      
      {% set data = state_attr('sensor.solarman_config_manager_restore_result', 'summary') %}
      {% set dry_run = state_attr('sensor.solarman_config_manager_restore_result', 'dry_run') %}
      {% if data and data.success is defined %}
      
      **Summary:**
      - ‚úÖ Success: {{ data.success }}
      - ‚ùå Failed: {{ data.failed }}
      - ‚è≠Ô∏è Skipped: {{ data.skipped }}
      
      {% if dry_run %}
      ‚ö†Ô∏è _This was a dry run - no changes were made._
      {% endif %}
      {% else %}
      _No restore operation performed yet._
      {% endif %}
